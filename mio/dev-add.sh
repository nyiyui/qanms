#!/bin/bash

set -eu

name="$1"
private_key="$2"
address="$3"
post_up="$4"
post_down="$5"
after="$6"
listen_port="$7"
wg="$8"
wg_quick="$9"
persist="${10}"

if [ -z "$wg" ]; then
  wg="$(which wg)"
fi

if [ -z "$wg_quick" ]; then
  wg_quick="$(which wg-quick)"
fi

umask 077
mkdir -p /etc/wireguard
config_path="/etc/wireguard/$name.conf"
cat > "$config_path" << EOF
# Generated by Qrystal-mio for network $name. DO NOT EDIT.
# This file will be overwritten during sync.
[Interface]
PrivateKey=$private_key
Address=$address
ListenPort=$listen_port

PostUp=$post_up
PostDown=$post_down

# After:
$after
EOF

ifaces=($($wg show interfaces))

log=$(mktemp)

if [[ "$persist" == "systemd" ]]; then
  unit_name="wg-quick@$name.service"
  systemctl enable "$unit_name" 2> $log || (1>&2 cat $log; 1>&2 cat "$config_path")
fi

if [[ " ${ifaces[*]} " =~ " $name " ]]; then
	# TODO: syncconf if ips don't change
	$wg_quick down "$name" 2> $log || (1>&2 cat $log; 1>&2 cat "$config_path")
fi

$wg_quick up "$name" 2> $log || 1>&2 cat $log
rm $log
